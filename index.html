<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>モバイルオーダー（キッチン）</title>
<style>
:root{
  --bg:#f7f7fb; --card:#fff; --text:#121826; --muted:#6b7280; --border:#e6e7ec; --accent:#2563eb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
  padding:16px; line-height:1.5; font-feature-settings:"tnum" 1,"cv01" 1;
}
.wrap{
  max-width:1400px;margin:0 auto;height:calc(100vh - 32px);
  display:grid;grid-template-columns:minmax(320px,420px) 1fr;gap:16px;min-height:0;
}

/* 左 */
.panel{
  background:var(--card);border:1px solid var(--border);border-radius:14px;display:grid;grid-template-rows:auto 1fr;min-height:0;
}
.panel header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid var(--border);
}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer}
.rows{list-style:none;margin:0;padding:0;overflow:auto;min-height:0}
.row{
  display:grid;grid-template-columns:48px 64px 1fr 136px 14px;align-items:center;gap:8px;
  padding:4px 10px;border-bottom:1px solid var(--border);cursor:pointer;background:#fff;
}
.row:hover{background:#fafafa}
.c-number{font-weight:800;color:var(--accent);text-align:center}
.c-time{color:var(--muted);text-align:center}
.c-seat{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-sum{text-align:right;white-space:nowrap}
.dot{width:8px;height:8px;border-radius:50%}
.dot.pending{background:#f59e0b}.dot.ready{background:#10b981}
.empty{padding:16px;color:var(--muted);text-align:center}

/* 右 */
.right{
  background:var(--card);border:1px solid var(--border);border-radius:16px;display:flex;flex-direction:column;min-height:0;
}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid var(--border)}
.detail{padding:12px 14px;overflow:auto;flex:1 1 auto}
.footer{padding:12px 14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
.primary{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:8px 16px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <section class="panel">
    <header><div>注文一覧</div><button id="refreshBtn" class="btn">更新</button></header>
    <ul id="rows" class="rows"></ul>
  </section>

  <section class="right">
    <div class="topbar">
      <div><span id="orderNumber" style="color:#2563eb;font-weight:800;"></span> <span id="detailSeat">注文を選択</span></div>
      <div><span id="detailTime"></span></div>
    </div>
    <div id="detailBody" class="detail">左の一覧から注文を選択してください。</div>
    <div class="footer">
      <div id="detailSummary"></div>
      <button id="doneBtn" class="primary" disabled>準備完了</button>
    </div>
  </section>
</div>

<script>
const API_BASE = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXX/exec'; // ←置き換え
const rowsEl = document.getElementById('rows');
const refreshBtn = document.getElementById('refreshBtn');
const orderNumber = document.getElementById('orderNumber');
const detailSeat = document.getElementById('detailSeat');
const detailTime = document.getElementById('detailTime');
const detailBody = document.getElementById('detailBody');
const detailSummary = document.getElementById('detailSummary');
const doneBtn = document.getElementById('doneBtn');

const yen = (n)=>'¥'+Number(n||0).toLocaleString('ja-JP');
const fmtHM = (v)=>{
  if (!v && v!==0) return '--:--';
  let d=null;
  if (typeof v==='number') d=new Date(v);
  else if (typeof v==='string') d=new Date(v);
  else if (v instanceof Date) d=v;
  if (!d || isNaN(d.getTime())) return '--:--';
  return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
};

const state = { pending:[], ready:[], selectedId:null };

function makeRow(o) {
  const li = document.createElement('li');
  li.className='row';
  li.dataset.id=o.groupId;
  const c1=document.createElement('div'); c1.className='c-number'; c1.textContent=o.orderNumber? `#${String(o.orderNumber).padStart(3,'0')}` : '--';
  const c2=document.createElement('div'); c2.className='c-time'; const t = o.status==='READY' ? (o.readyTs||o.updatedTs||o.createdTs) : o.createdTs; c2.textContent = fmtHM(t);
  const c3=document.createElement('div'); c3.className='c-seat'; c3.textContent=o.seat?`座席 ${o.seat}`:'テイクアウト';
  const c4=document.createElement('div'); c4.className='c-sum'; c4.innerHTML=`<span class="qty">${o.totalQuantity}点</span> <span class="amt">${yen(o.totalAmount)}</span>`;
  const c5=document.createElement('div'); const dot=document.createElement('span'); dot.className='dot '+(o.status==='READY'?'ready':'pending'); c5.append(dot);
  li.append(c1,c2,c3,c4,c5);
  li.onclick = ()=>{ state.selectedId=o.groupId; renderList(); renderDetail(); };
  return li;
}

function renderList() {
  rowsEl.innerHTML='';
  const merged=[...state.pending,...state.ready];
  if (!merged.length) { const d=document.createElement('div'); d.className='empty'; d.textContent='現在、注文はありません。'; rowsEl.append(d); return; }
  merged.forEach(o=> rowsEl.append(makeRow(o)));
}

function renderDetail() {
  const all=[...state.pending,...state.ready];
  const o=all.find(x=> x.groupId===state.selectedId);
  if (!o) {
    orderNumber.textContent=''; detailSeat.textContent='注文を選択'; detailTime.textContent='';
    detailBody.textContent='左の一覧から注文を選択してください。'; detailSummary.textContent='';
    doneBtn.disabled=true; doneBtn.textContent='準備完了'; doneBtn.onclick=null;
    return;
  }
  orderNumber.textContent = o.orderNumber? `注文 #${String(o.orderNumber).padStart(3,'0')}`:'';
  detailSeat.textContent = o.seat? `座席 ${o.seat}`:'テイクアウト';
  const t = o.status==='READY' ? (o.readyTs||o.updatedTs||o.createdTs) : o.createdTs;
  detailTime.textContent = fmtHM(t);

  const items=document.createElement('div');
  o.items.forEach(it=>{
    const r=document.createElement('div');
    r.textContent = `${it.itemName} ×${it.quantity} … ${yen(it.totalPrice)}`;
    items.append(r);
  });
  detailBody.innerHTML=''; detailBody.append(items);
  if (o.note) { const n=document.createElement('div'); n.textContent=`備考: ${o.note}`; detailBody.append(n); }
  detailSummary.textContent = `${o.totalQuantity}点 / 合計 ${yen(o.totalAmount)}`;

  doneBtn.disabled = (o.status==='READY');
  doneBtn.textContent = (o.status==='READY') ? '提供済み' : '準備完了';
  doneBtn.onclick = ()=>{
    doneBtn.disabled=true; doneBtn.textContent='処理中…';
    fetch(`${API_BASE}?action=ready`, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
      body: JSON.stringify({ groupId: o.groupId })
    })
    .then(r=>r.json())
    .then(_=> fetchOrders())
    .catch(err=>{
      alert('更新に失敗しました: '+(err && err.message || String(err)));
      doneBtn.disabled=false; doneBtn.textContent='準備完了';
    });
  };
}

function fetchOrders() {
  refreshBtn.disabled=true;
  return fetch(`${API_BASE}?action=kitchen&limitCompleted=200`)
    .then(r=>r.json())
    .then(res=>{
      state.pending = res.pending || [];
      state.ready = res.completed || [];
      if (!state.selectedId) {
        const first = state.pending[0] || state.ready[0];
        if (first) state.selectedId = first.groupId;
      }
      renderList(); renderDetail(); refreshBtn.disabled=false;
    })
    .catch(err => { console.error(err); refreshBtn.disabled=false; alert('注文の取得に失敗しました。'); });
}

refreshBtn.onclick = ()=> fetchOrders();
fetchOrders();
setInterval(fetchOrders, 8000);
</script>
</body>
</html>
